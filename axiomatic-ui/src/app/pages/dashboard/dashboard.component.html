<div class="dash-wrap">
  <!-- Top bar -->
  <!-- <div class="topbar">
    <div class="right">
      <button
        class="published-on-algo-btn"
        mat-stroked-button
        *ngIf="response?.publish?.status === 'success' && txId"
        (click)="openExplorer()"
      >
        Published on Algorand
      </button>
      <button
        class="to-publish-on-algo-btn"
        mat-stroked-button
        *ngIf="!response && !txId"
        (click)="openExplorer()"
      >
        Nothing has been published yet
      </button>
    </div>
  </div> -->

  <div class="grid">
    <!-- LEFT: form + actions -->
    <div class="col-left">
      <app-property-form
        [(value)]="formValue"
        [loading]="loading"
      ></app-property-form>

      <div class="card actions" role="region" aria-label="Actions">
        <!-- Rail di azioni: 4 step collegati -->
        <div class="action-rail" role="group" aria-label="Workflow actions">
          <!-- <mat-slide-toggle
            [checked]="attOnly"
            (change)="attOnly = $event.checked"
            [disabled]="loading || publishing"
            matTooltip="If enabled, create attestation bundle without publishing on-chain"
            >Attestation only</mat-slide-toggle
          > -->

          <!-- 1) Send -->
          <button
            class="pill rail-btn"
            mat-raised-button
            color="primary"
            (click)="sendRequest()"
            [disabled]="!canSend"
            [ngClass]="statusClass('request')"
            matTooltip="Validate & score the payload with the trained model."
          >
            <span>Evaluate</span>
          </button>

          <span class="connector" [class.on]="stepDone('request')"></span>

          <!-- 2) Publish -->
          <button
            class="pill rail-btn"
            mat-raised-button
            color="primary"
            (click)="publishToBlockchain()"
            [disabled]="!canPublish"
            [ngClass]="statusClass('publish')"
            matTooltip="Anchor a tamper-proof hash to Algorand (low fees, fast finality)."
          >
            <span>Publish</span>
          </button>

          <span class="connector" [class.on]="stepDone('publish')"></span>

          <!-- 4) Download -->
          <button
            class="pill rail-btn"
            mat-raised-button
            color="primary"
            (click)="downloadResponse()"
            [disabled]="!canDownload"
            [ngClass]="statusClass('download')"
            matTooltip="Download audit ZIP (if available) or JSON response."
          >
            <span>Download</span>
          </button>
        </div>

        <div class="error-wrap" *ngIf="errorMessage && !response">
          <pre>{{ errorMessage }}</pre>
        </div>
      </div>
    </div>

    <!-- RIGHT: playbook (pre-eval) oppure valuation / publish / verify -->
    <div
      class="col-right"
      [ngStyle]="{ 'flex-direction': response ? 'column' : 'row' }"
    >
      <!-- TODO: guided Playbook (mostrato finché non c’è una valutazione) -->

      <!-- Post-evaluation cards -->
      <ng-container *ngIf="response">
        <app-valuation-card [res]="response"></app-valuation-card>

        <app-publish-details
          *ngIf="response?.publish"
          [res]="response"
        ></app-publish-details>

        <!-- Verify: visibile dalla prima valutazione.
             Se c'è un publish, precompila con txId e call-to-action esplicita -->
        <div class="card verify-card" id="verify-card">
          <div class="qv-head">
            <span class="qv-title">Verify</span>
            <span class="qv-muted">
              · paste TXID or pick from last publish</span
            >
          </div>
          <!-- <p class="verify-hint" *ngIf="!response?.publish">
            You can paste any Algorand txid to check confirmations. After you
            publish, we’ll prefill this with your latest <strong>txid</strong>.
          </p> -->
          <p class="verify-hint" *ngIf="response?.publish">
            Latest publish:
            <strong>{{
              txId ?? "No TXID has been sent in this session."
            }}</strong>
          </p>

          <app-quick-verify
            [defaultTxid]="txId || ''"
            (submitTxid)="onVerifyTx($event)"
          ></app-quick-verify>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Overlay spinner -->
  <div class="screen-loading-cover" *ngIf="loading || publishing">
    <div class="spinner">
      <img src="logo.png" alt="Axiomatic" class="axi-spinner-logo" />
      <div class="label">
        {{ publishing ? "Publishing to Algorand…" : "Evaluating…" }}
      </div>
    </div>
  </div>

  <footer class="footer">
    <!-- <nav class="footer-nav">
      <a href="#" rel="noopener">Product</a>
      <a href="#" rel="noopener">Docs</a>
      <a href="#" rel="noopener">Company</a>
      <a href="#" rel="noopener">Legal</a>
    </nav> -->
    <div class="footer-meta">
      <span>No financial advice • GDPR note</span>
      <span>© 2025 Axiomatic Oracle</span>
    </div>
  </footer>
</div>
